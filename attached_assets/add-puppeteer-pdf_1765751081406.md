# Add Puppeteer-Based PDF Generation

## Problem

The current PDF generation uses `html2pdf.js` on the frontend, which:
- Renders content as **raster images** (not vector)
- Produces **non-searchable** PDFs (text is pixels, not actual text)
- Can fail on large documents due to canvas size limits
- Loses quality when zoomed

## Solution

Replace with **Puppeteer** running on the backend. Puppeteer uses headless Chrome to render the page and generate a PDF with:
- Real, selectable, searchable text
- Vector graphics
- Perfect CSS fidelity (Tailwind, fonts, everything)
- Professional print quality

## Architecture

```
Frontend                    Backend (Python/FastAPI)
─────────                   ────────────────────────
User clicks "PDF"  ──────►  POST /api/research/{run_id}/pdf
                            │
                            ├─► Fetch report data from database
                            ├─► Render HTML template with report content
                            ├─► Call Puppeteer (via pyppeteer or subprocess)
                            ├─► Generate PDF with Chrome's print engine
                            │
                   ◄────────┴─► Return PDF file as download
```

## Implementation Steps

### 1. Install Dependencies

**Option A: Use pyppeteer (Python port)**
```bash
pip install pyppeteer
```
First run will auto-download Chromium.

**Option B: Use Node.js Puppeteer via subprocess**
```bash
npm install puppeteer
```
Then call it from Python using subprocess.

Recommend **Option A (pyppeteer)** for simpler integration with FastAPI.

### 2. Create PDF HTML Template

Create a standalone HTML template that can render the report beautifully for print. This template should:

- Include all necessary Tailwind CSS (inline or via CDN)
- Use print-optimized styling (proper margins, page breaks)
- Accept the report content, title, and citations as template variables
- Use a light theme (white background, dark text) for print
- Include a header with title and metadata
- Include a footer with page numbers
- Style blockquotes, tables, code blocks appropriately for print

Location: `templates/pdf_report.html` or similar

### 3. Create PDF Generation Endpoint

Add a new endpoint to `main.py`:

**Endpoint:** `GET /api/research/{run_id}/pdf`

**Logic:**
1. Authenticate the user (same as other endpoints)
2. Fetch the research record from database by run_id
3. Verify the user owns this research
4. Check that consensus_report exists
5. Render the HTML template with:
   - `title`: The user's query
   - `content`: The consensus report (markdown → HTML)
   - `citations`: The citations list
   - `created_at`: Timestamp
6. Launch pyppeteer browser
7. Create new page, set content to rendered HTML
8. Generate PDF with options:
   - Format: A4
   - Print background: true
   - Margins: reasonable (e.g., 2cm)
9. Close browser
10. Return PDF as file response with appropriate headers:
    - `Content-Type: application/pdf`
    - `Content-Disposition: attachment; filename="research-report.pdf"`

### 4. Handle Markdown to HTML Conversion

The report content is in Markdown format. For the PDF template, convert it to HTML on the backend using a Python markdown library:

```bash
pip install markdown
```

Use extensions for:
- Tables: `tables`
- Fenced code: `fenced_code`
- Table of contents (optional): `toc`

### 5. Update Frontend

In `App.tsx`, update the `handleDownloadPDF` function:

**Current approach (remove):**
- Uses html2pdf.js to capture DOM element
- Generates PDF client-side

**New approach:**
- Make a GET request to `/api/research/{run_id}/pdf`
- Receive the PDF as a blob
- Create a download link and trigger download
- Show loading state while generating

Remove the `html2pdf.js` dependency from package.json after confirming the new approach works.

### 6. PDF Template Styling Guidelines

The PDF template should include styles for:

**Typography:**
- Body: 11-12pt, 1.5 line-height
- Headings: Clear hierarchy, avoid orphans (use `break-after: avoid`)
- Max width: ~65 characters per line for readability

**Page layout:**
- Margins: 2cm all sides (or 1 inch)
- Page size: A4 portrait
- Header: Report title, date
- Footer: Page numbers, "Generated by Meta Deep Research"

**Content:**
- Tables: Borders, proper padding, avoid breaking across pages
- Code blocks: Light gray background, monospace font, wrap long lines
- Blockquotes: Left border accent, subtle background
- Links: Show URL in parentheses after link text for print

**Page breaks:**
- Avoid breaking inside tables, code blocks, blockquotes
- Start major sections on new page if near bottom
- Use `break-inside: avoid` on key elements

### 7. Error Handling

Handle these cases:
- Research not found → 404
- User doesn't own research → 403
- Report not yet complete → 400 with message
- Puppeteer/browser launch fails → 500 with error details
- Timeout for large reports → Set reasonable timeout (30-60 seconds)

### 8. Performance Considerations

- **Browser reuse:** For high traffic, consider keeping a browser instance alive and reusing pages rather than launching new browser per request
- **Caching:** If the same report is requested multiple times, consider caching the PDF
- **Timeout:** Set a reasonable timeout (30s) for PDF generation
- **Memory:** Puppeteer can be memory-intensive; monitor usage

## Files to Create/Modify

**Create:**
- `templates/pdf_report.html` - HTML template for PDF rendering

**Modify:**
- `main.py` - Add PDF generation endpoint
- `client/src/App.tsx` - Update handleDownloadPDF to use backend endpoint
- `pyproject.toml` - Add pyppeteer and markdown dependencies
- `client/package.json` - Remove html2pdf.js (after testing)

## Testing

1. Complete a research query
2. Click the PDF download button
3. Verify the PDF:
   - Opens correctly in PDF viewer
   - Text is selectable and searchable
   - Styling looks professional (headings, tables, code blocks)
   - Citations are properly formatted
   - Page breaks are sensible
   - Header/footer appear on each page

## Expected Result

Professional, searchable PDF reports that:
- Match the quality of consulting firm deliverables
- Have selectable, searchable text
- Print cleanly on paper
- Include proper headers, footers, and page numbers
- Preserve all formatting from the web view
